apiVersion: pulumi.com/v1
kind: Program
metadata:
  name: lego
program:
  resources:
    bucket:
      type: aws:s3:BucketV2
    bucketOwnershipControls:
      type: aws:s3:BucketOwnershipControls
      properties:
        bucket: ${bucket.id}
        rule:
          objectOwnership: BucketOwnerPreferred
    bucketPublicAccessBlock:
      type: aws:s3:BucketPublicAccessBlock
      properties:
        bucket: ${bucket.id}
        blockPublicAcls: false
        blockPublicPolicy: false
        ignorePublicAcls: false
        restrictPublicBuckets: false
    bucketACL:
      type: aws:s3:BucketAclV2
      properties:
        bucket: ${bucket.id}
        acl: public-read
      options:
        dependsOn:
        - ${bucketOwnershipControls}
        - ${bucketPublicAccessBlock}
    webSiteContent:
      type: aws:s3:BucketWebsiteConfigurationV2
      properties:
        bucket: ${bucket.id}
        indexDocument:
          suffix: index.html
    index.html:
      type: aws:s3:BucketObject
      properties:
        bucket: ${bucket.id}
        content: |
          Hello Lego!
        contentType: text/html
        acl: public-read
  outputs:
    url: http://${webSiteContent.websiteEndpoint}
---
apiVersion: pulumi.com/v1
kind: Stack
metadata:
  name: lego
spec:
  stack: ediri/lego/dev
  envRefs:
    AWS_ACCESS_KEY_ID:
      type: Secret
      secret:
        name: aws-credentials
        key: AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      type: Secret
      secret:
        name: aws-credentials
        key: AWS_SECRET_ACCESS_KEY
  programRef:
    name: lego
  destroyOnFinalize: false
  config:
    aws:region: eu-central-1
